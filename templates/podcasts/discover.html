{% extends 'base.html' %}
{% load static %}

{% block title %}Discover Music - MusicStream{% endblock %}

{% block content %}
<div class="discover-container">
    <div class="discover-header">
        <h1 class="discover-title">
            <i class="fas fa-compass"></i>
            Discover Music
        </h1>
        <p class="discover-subtitle">Find your next favorite song</p>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar mb-4">
        <div class="row">
            <div class="col-md-4">
                <select class="form-select" id="genre-filter">
                    <option value="">All Genres</option>
                    <option value="pop">Pop</option>
                    <option value="rock">Rock</option>
                    <option value="hip-hop">Hip Hop</option>
                    <option value="electronic">Electronic</option>
                    <option value="classical">Classical</option>
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="sort-filter">
                    <option value="recent">Recently Added</option>
                    <option value="popular">Most Popular</option>
                    <option value="plays">Most Played</option>
                    <option value="alphabetical">A-Z</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="search-input" placeholder="Search songs...">
            </div>
        </div>
    </div>

    <!-- Songs List -->
    <div class="music-list-container">
        <div class="latest-songs">
            <h2 class="section-title">Latest Songs</h2>
            
            {% if songs %}
                <div class="songs-list">
                    {% for song in songs %}
                    <div class="music-track-item" data-song-id="{{ song.id }}">
                        <div class="track-info">
                            <img src="{{ song.cover_image.url|default:'/static/images/default-album-art.jpg' }}" 
                                 alt="{{ song.title }}" class="track-image">
                            <div class="track-details">
                                <div class="track-title">{{ song.title }}</div>
                                <div class="track-artist">{{ song.artist.name|default:'Unknown Artist' }}</div>
                                <div class="track-meta">
                                    <span class="track-duration">{{ song.duration|default:'0:00' }}</span>
                                    <span class="track-plays">
                                        <i class="fas fa-play"></i> {{ song.play_count|default:0 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="track-actions">
                            <button class="btn-play-pause song-play-btn" 
                                    data-song-id="{{ song.id }}" 
                                    data-media-type="song"
                                    title="Play {{ song.title }}">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary dropdown-toggle" 
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-plus"></i> Add to Playlist
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-heart"></i> Add to Favorites
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <i class="fas fa-share"></i> Share
                                        </a>
                                    </li>
                                    {% if song.user == request.user %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'music:edit_song' song.id %}">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'music:delete_song' song.id %}">
                                            <i class="fas fa-trash"></i> Delete
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-music fa-3x mb-3 text-muted"></i>
                    <h4 class="text-muted">No songs found</h4>
                    <p class="text-muted">Be the first to upload a song!</p>
                    {% if user.is_authenticated %}
                        <a href="{% url 'music:upload_song' %}" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload Song
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Play Button Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const songPlayBtns = document.querySelectorAll('.song-play-btn');
    
    songPlayBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const songId = this.dataset.songId;
            
            // Stop any currently playing media first
            if (window.mediaPlayer) {
                if (window.mediaPlayer.currentMediaType === 'podcast') {
                    window.mediaPlayer.stopPodcast();
                } else if (window.mediaPlayer.currentMediaType === 'song') {
                    window.mediaPlayer.stopSong();
                }
                
                // Play the selected song
                window.mediaPlayer.playSong(songId);
                
                // Update UI to show this song is playing
                document.querySelectorAll('.song-play-btn').forEach(b => {
                    b.classList.remove('playing');
                    b.innerHTML = '<span>▶</span>';
                });
                
                this.classList.add('playing');
                this.innerHTML = '<span>⏸</span>';
            }
        });
    });
    
    // Filter functionality
    const genreFilter = document.getElementById('genre-filter');
    const sortFilter = document.getElementById('sort-filter');
    const searchInput = document.getElementById('search-input');
    
    function filterSongs() {
        const genre = genreFilter.value;
        const sort = sortFilter.value;
        const search = searchInput.value.toLowerCase();
        
        // This would typically make an AJAX call to filter songs
        // For now, we'll just reload the page with query parameters
        const params = new URLSearchParams();
        if (genre) params.append('genre', genre);
        if (sort) params.append('sort', sort);
        if (search) params.append('search', search);
        
        const url = `${window.location.pathname}?${params.toString()}`;
        window.location.href = url;
    }
    
    if (genreFilter) genreFilter.addEventListener('change', filterSongs);
    if (sortFilter) sortFilter.addEventListener('change', filterSongs);
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filterSongs();
            }
        });
    }
});
</script>
{% endblock %}